<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="rental.mapper.RentalReservationMapper">
	<select id="getCount" resultType="int" parameterType="hashmap">
		select count(*)
		from rental_reservation
		where uuid = #{uuid}
		<if test="year != null and year != ''">
			and to_char(created_at, 'yyyy') = #{year}
		</if>
	</select>
	<resultMap type="rental.dto.RentalReservationPrintDto" id="RentalReservationPrint">
        <id column="rent_reserv_id" property="rent_reserv_id"/>
        <result column="rentalshop_id" property="rentalshop_id"/>
        <result column="uuid" property="uuid"/>
        <result column="rental_start" property="rental_start"/>
		<result column="rental_end" property="rental_end"/>
        <result column="total_price" property="total_price"/>
        <result column="status" property="status"/>
        <result column="created_at" property="created_at"/>
        <result column="name" property="name"/>
        <result column="payment_id" property="payment_id"/>
        <result column="user_id" property="userId"/>
	    <result column="user_email" property="userEmail"/>
	    <result column="user_name" property="userName"/>
	    <result column="phone" property="phone"/>
        
        <collection property="rentalReservationItemDtoList" ofType="rental.dto.RentalReservationItemDto">
            <id column="item_id" property="item_id"/>            
            <result column="rent_reserv_id" property="rent_reserv_id"/>
            <result column="rental_item_id" property="rental_item_id"/>
            <result column="item_id" property="item_id"/>
            <result column="item_name" property="item_name"/>
            <result column="quantity" property="quantity"/>
            <result column="subtotal_price" property="subtotal_price"/>
        </collection>
    </resultMap>
    
    
	<resultMap type="rental.dto.RentalReservationListDto" id="RentalReservationListMapper">	
		<id column="rent_reserv_id" property="rent_reserv_id"/>
		<result column="rentalshop_id" property="rentalshop_id"/>
		<result column="uuid" property="uuid"/>
		<result column="rental_start" property="rental_start"/>
		<result column="rental_end" property="rental_end"/>
		<result column="total_price" property="total_price"/>
		<result column="status" property="status"/>
		<result column="created_at" property="created_at"/>
						
		<result column="name" property="name"/>
		<result column="payment_id" property="payment_id"/>
		
		<collection property="rentalReservationItemDtoList" ofType="rental.dto.RentalReservationItemDto">
			<id column="item_id" property="item_id"/>
			<result column="rent_reserv_id" property="rent_reserv_id"/>
			<result column="item_id" property="item_id"/>
			<result column="item_name" property="item_name"/>
			<result column="quantity" property="quantity"/>
			<result column="subtotal_price" property="subtotal_price"/>
		</collection>
	</resultMap>


	<select id="selectByUuid" resultMap="RentalReservationListMapper" parameterType="hashmap">
		select rr.rent_reserv_id, rr.rentalshop_id, rr.uuid, rr.rental_start, rr.rental_end, rr.total_price, rr.status, rr.created_at,
			(select name from rentalshop where rentalshop_id = rr.rentalshop_id) name, (select payment_id from rent_payments where rent_reserv_id = rr.rent_reserv_id) payment_id,
			rri.item_id, rri.item_id, (select item_name from rent_item where item_id = rri.item_id) item_name, rri.quantity, rri.subtotal_price
		from rental_reservation rr left join rent_reservation_item rri on rr.rent_reserv_id = rri.rent_reserv_id
		where rr.rent_reserv_id in (
			select rent_reserv_id
			from (
				select rownum rn, rrl.*
				from (
					select rent_reserv_id
					from rental_reservation
					where uuid = #{uuid}
					<if test="year != null and year != ''">
						and to_char(created_at, 'yyyy') = #{year}
					</if>
					order by created_at desc
				) rrl
			)
			where rn between #{startRow} and #{endRow}
		)
		order by created_at desc
	</select>
	
	<select id="selectReservationByRentalId" resultMap="RentalReservationPrint" parameterType="map">
        SELECT 
            rr.rent_reserv_id, 
            rr.rentalshop_id, 
            rr.uuid, 
            rr.rental_start,
            rr.rental_end,
            rr.total_price, 
            rr.status, 
            rr.created_at,
            r.name AS rental_name, 
            u.name AS user_name,
            u.user_id, 
		    u.email AS user_email, 
		    u.phone,
            rp.payment_id, 
            rri.rental_item_id,
            rri.item_id, 
            ri.item_name,
            ri.category_id,
            rri.quantity, 
            rri.subtotal_price
        FROM rental_reservation rr
        LEFT JOIN rentalshop r ON rr.rentalshop_id = r.rentalshop_id
        LEFT JOIN rental_payments rp ON rr.rent_reserv_id = rp.rent_reserv_id
        LEFT JOIN rental_reservation_item rri ON rr.rent_reserv_id = rri.rent_reserv_id
        LEFT JOIN rent_item ri ON rri.item_id = ri.item_id
        LEFT JOIN users u ON rr.uuid = u.uuid
        <where>
		    <if test="rentalID != null">
		        rr.rentalshop_id = #{rentalID}
		    </if>
		    <if test="reservId != null">
		        rr.rent_reserv_id = #{reservId}
		    </if>
		    <if test="reserv_date1_start != null and reserv_date1_end != null">
		        AND rr.rental_start BETWEEN #{reserv_date1_start} AND #{reserv_date1_end}
		    </if>
		    <if test="reserv_date2_start != null and reserv_date2_end != null">
		        AND rr.rental_end BETWEEN #{reserv_date2_start} AND #{reserv_date2_end}
		    </if>
		    <if test="created_at_start != null and created_at_end != null">
		        AND rr.created_at BETWEEN #{created_at_start} AND #{created_at_end}
		    </if>
		    <if test="name != null">
		        AND U.NAME LIKE '%' || #{name} || '%'
		    </if>
		    <if test="user_id != null">
		        AND U.USER_ID LIKE '%' || #{user_id} || '%'
		    </if>
		    <if test="email != null">
		        AND U.EMAIL LIKE '%' || #{email} || '%'
		    </if>
		</where>
  	</select>
  	
  	<select id="getRentalIdByUUID" resultType="Integer">
        SELECT rentalshop_id FROM Rental WHERE UUID = #{adminUUID}
    </select>
    
    <update id="updateReservationStatusToCompleted" parameterType="map">
		UPDATE rental_reservation
		SET status = '반납완료'
		WHERE rent_reserv_id = #{reserv_ID}
		AND status = '대여중'		
	</update>
    <!-- 스키장 예약 고유번호를 받아 예약 상태 업데이트 -->
    <update id="reservationCancel">
        UPDATE rental_RESERVATION SET STATUS='CANCELLED' WHERE rent_reserv_id=#{rent_reserv_id}
    </update>

    <update id="reservationComplete">
        UPDATE rental_RESERVATION SET STATUS='COMPLETED' WHERE rent_reserv_id=#{rent_reserv_id}
    </update>
</mapper>